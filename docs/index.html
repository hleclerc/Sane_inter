
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../../../favicon.ico">

    <title>The Sane language</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <link href="doc/dashboard.css" rel="stylesheet">

    <style>
      pre {
        padding: 1rem;
        margin: 2rem 0;
        background: rgb(235, 235, 235);
        border-radius: 2px;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
        /* border: 1px solid #272a2c;
        border-radius: 2px;*/
        line-height: 1.15;
      }
      h1 {
        font-size: 250%;
        color:rgb(110, 45, 19);
      }
      h2 {
        font-size: 160%;
        color:rgb(110, 45, 19);
      }
      
      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        display: block;
        overflow-x: hidden;
        overflow-y: auto
      } 
   </style>
  </head>

  <body>
    <!-- <header>
      <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="#">Sane</a>
        <button class="navbar-toggler d-lg-none" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
          </ul>
        </div>
      </nav>
    </header> -->

    <div class="container-fluid">
      <div class="row">
<nav class="col-sm-3 col-md-2 d-none d-sm-block bg-light sidebar">
<ul>
</ul/>
<ul class="nav nav-pills flex-column">
<li class="nav-item"> <a class="nav-link" href="#WhatisSane">What is Sane ?</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Basesyntax">Base syntax</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Templates">Templates</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Objects">Objects</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Typesforliterals">Types for literals</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Memory">Memory</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Generativeprogramming">Generative programming</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Activelibraries">Active libraries</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Examplesofactivelibraries">Examples of active libraries</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Asynchronouscode">Asynchronous code</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Codegeneration">Code generation</a> </li>
<li class="nav-item"> <a class="nav-link" href="#Currentstatus">Current status</a> </li>
</ul>
</nav>
<main role="main" class="col-sm-9 ml-sm-auto col-md-10 pt-3">
<section id="WhatisSane">
<h1>What is Sane ?</h1>
<p>Sane is a code generator, designed to <strong>speed up the development</strong> of programs optimized for <strong>execution speed and memory usage</strong>.</p>

<p>In itself, the language is not going to provide any abstraction that would drive the programmers away from the hardware, nor any stubborn dogmatic rule that would perpetually force them to spend time on workarounds. In place of that, Sane allows and promotes the use and development of <strong>active libraries</strong> (libraries that take part in the process of compilation). Teams and developers can therefore <strong>choose the <em>right</em> level of abstraction</strong>, depending on the context, to meet the needs in terms of programming speed, security and execution performance.</p>

<p>Sane is basically very close to C++, except for the <strong>streamlined syntax</strong>, the <strong>compilation processes</strong>, and last but not least, the dramatically improved <strong>compile-time abilities</strong> which notably drives the tools for <strong>generative programming</strong> and <strong>compiler <em>aided</em> decisions</strong>.</p>

<!-- (notably for **generative programming** and **compiler aided decisions**) -->

<p>Sane is the acronym of <em>Software engineers Are Not Evil</em>.</p>

<!-- Otherwise, the name could have been BSWDNPA (Blocking The Steering Wheel Does Not Prevent Accidents). -->

<h2>Organization of this document</h2>

<p>This documentation starts with the base syntax. The main differences with the base C++ are then emphasized, to drive thereafter to applications on generative programming. It is then followed by examples of commonly used <em>optional</em> abstractions (asynchronous execution, security enforcements, ...), illustrating the principle of <em>active library</em>.</p>

<!-- Zero-cost enforcements and abstractions are always present, but when it comes to compromises, new ideas or specific needs, we believe that the choice must come from teams  -->

<!-- enabling much better **control** (notably via **active libraries** for *powerful, transparent and controllable* extensions) and  (streamlined syntax, assumed meta and generative programming, deep introspection, etc...).

We believe that we are able to decide what kind of enforcements and abstractions we need, depending on the context. Zero-cost security enforcements are always 
 Things like enforced security, automated handling of asynchronicity, auto-vectorization or  can be absolutely awesome and strongly differentiating, but it depends of the kind of program, the stage (prototype, ...), the stakes, ... Thus, these kind of features are not in the core language but are in libraries 
-->

<!-- libraries. -->
</section>
<section id="Basesyntax">
<h1>Base syntax</h1>
<h2>Simplifications</h2>

<p>For calls, functions definitions, ifs, ... the parentheses become optional. Semicolon, braces and returns have undergone the same treatment.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># &#39;foo&#39; is a function with two (unconstrained) parameters &#39;a&#39; and &#39;b&#39;</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">a</span>, <span style="color: #000000">b</span>
    <span style="color: #000000">info</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">b</span>

<span style="color: #938d7f; font-style: italic"># equivalent to foo( 5, min( 10, 15 ) )</span>
<span style="color: #938d7f; font-style: italic"># (Auto-calls are handled right to left)</span>
<span style="color: #000000">foo</span> <span style="color: #93488f">5</span>, <span style="color: #000000">min</span> <span style="color: #93488f">10</span>, <span style="color: #93488f">15</span>
</pre></div>
<p>Line continuations are automatic (thanks notably to operators and block structures).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># b is the rhs of the &#39;+&#39;</span>
<span style="color: #000000">foo</span> <span style="color: #93488f">10</span>, <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span>
    <span style="color: #000000">b</span>

<span style="color: #938d7f; font-style: italic"># argument list can be specified in block lines.</span>
<span style="color: #938d7f; font-style: italic"># In this case, the comma become optionnal</span>
<span style="color: #000000">foo</span>
    <span style="color: #93488f">10</span>
    <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">b</span>
</pre></div>
<p>But frantic one-liners, are still welcome to play the game :)</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># &#39;;&#39; acts as a carriage return</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">a</span>, <span style="color: #000000">b</span>; <span style="color: #000000">info</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">b</span>

<span style="color: #938d7f; font-style: italic"># &#39;()&#39; allows for block definitions</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">bar</span> <span style="color: #000000">a</span>, <span style="color: #000000">b</span>; ( <span style="color: #000000">c</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">b</span>; <span style="color: #93488f">2</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">c</span> )
</pre></div>
<p>As a rule of thumb, if the compiler can take care of an <em>obvious</em> simplification, this simplification is enabled for the greater goods.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># Std def of a lambda functions without parameter</span>
<span style="color: #000000">l0</span> <span style="color: #6d3642; font-weight: bold">:=</span> () <span style="color: #6d3642; font-weight: bold">=&gt;</span> <span style="color: #93488f">17</span> <span style="color: #938d7f; font-style: italic"># std def of a lambda func without parameter</span>
<span style="color: #938d7f; font-style: italic"># in the following line, as &#39;:=&#39; can&#39;t be an argument spec.</span>
<span style="color: #938d7f; font-style: italic"># we safely assume that &#39;=&gt; 17&#39; is a no parm lambda</span>
<span style="color: #000000">l1</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #6d3642; font-weight: bold">=&gt;</span> <span style="color: #93488f">17</span>

<span style="color: #938d7f; font-style: italic"># works of course with all the kinds of operators</span>
<span style="color: #000000">foo</span>
    <span style="color: #6d3642; font-weight: bold">=&gt;</span> <span style="color: #93488f">17</span> <span style="color: #938d7f; font-style: italic"># unnamed arg</span>
    <span style="color: #000000">arg</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #6d3642; font-weight: bold">=&gt;</span> <span style="color: #93488f">17</span> <span style="color: #938d7f; font-style: italic"># named arg</span>
</pre></div>
<h2>Parameters</h2>

<p>Parameters of callable objects (<code>def</code>s, <code>classes</code>s, <code>lambda</code>s, ...) can have default values, constraints (with free parameters) and can be selected using their names.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># a must be a SI32 (32 bits signed integer)</span>
<span style="color: #938d7f; font-style: italic"># b and c have default values &#39;a + 1&#39; and &#39;b + 1&#39;</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">a</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">SI32</span>, <span style="color: #000000">b</span><span style="color: #6d3642; font-weight: bold">?</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">1</span>, <span style="color: #000000">c</span><span style="color: #6d3642; font-weight: bold">?</span> <span style="color: #000000">b</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">1</span>
    <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">b</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">c</span>

<span style="color: #938d7f; font-style: italic"># argument may be named. Default values are computed on the go</span>
<span style="color: #000000">foo</span> <span style="color: #93488f">15</span>, <span style="color: #000000">c</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #93488f">18</span>
</pre></div>
<p>By default, arguments is passed as <em>immutable references</em>.</p>

<p>"Deconstification" is possible, using the <code>mut</code> keyword.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># modification of b is possible inside this function</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">a</span>, <span style="color: #005782">mut</span> <span style="color: #000000">b</span>
    <span style="color: #000000">b</span> <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #000000">a</span>

<span style="color: #938d7f; font-style: italic"># =&gt; 25</span>
<span style="color: #000000">b</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">10</span>
<span style="color: #000000">foo</span> <span style="color: #93488f">15</span>, <span style="color: #000000">b</span>
<span style="color: #000000">info</span> <span style="color: #000000">b</span>
</pre></div>
<h2>Qualifiers</h2>

<p>Qualifiers like <code>private</code>, <code>protected</code>, <code>static</code>, <code>global</code>... may be associated with one or several declarations at the same time if written in sub-blocks.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #00aaff">class</span> <span style="color: #000000">Mesh</span>[ <span style="color: #000000">ElemTypes</span> ]
    <span style="color: #938d7f; font-style: italic"># A public method</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">area</span>
        <span style="color: #000000">elems</span>.<span style="color: #000000">sum</span> <span style="color: #000000">e</span> <span style="color: #6d3642; font-weight: bold">=&gt;</span> <span style="color: #000000">e</span>.<span style="color: #000000">with_coords</span>( <span style="color: #000000">e</span>.<span style="color: #000000">nodes</span>.<span style="color: #000000">map</span> <span style="color: #000000">n</span> <span style="color: #6d3642; font-weight: bold">=&gt;</span> <span style="color: #000000">nodes</span>[ <span style="color: #000000">n</span> ] ).<span style="color: #000000">area</span>

    <span style="color: #938d7f; font-style: italic"># A private section (with two attributes)</span>
    <span style="color: #005782">private</span>
        <span style="color: #000000">nodes</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Vec</span>[ <span style="color: #000000">Node</span> ]
        <span style="color: #000000">elems</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">HetVec</span>[ ...<span style="color: #000000">ElemTypes</span> ]
</pre></div>
<p></p>
</section>
<section id="Templates">
<h1>Templates</h1>
<p>The word "template" refers to that of C++. Template in Sane works roughly in the same way as in C++: functions code are actually generated according to the input types and needed compile-time known values. It enables a first-level of compile-time or static polymorphism.</p>

<p>The main differences with C++ are that:</p>

<ul>
<li>By default, every callable (<code>def</code>, <code>class</code>, <code>lambda</code>, ...) is a template. There's no special syntax for templates.</li>
<li>The compiler acts like a server, enabling aggressive <strong>per function caching and hashing</strong>, for the compilation speed and the binary sizes.</li>
<li><strong>Template parameters can be of any type</strong>, </li>
<li>Selection of surdefinitions work with <strong>programmable criteria</strong> than can work at compile-time (preferred) or run-time (if needed).</li>
</ul>

<h2>Priorities and conditions</h2>

<p>An arbitrary number or surdefinitions may lie on the same scope. Selection may depend on programmable priorities (<code>pertinence</code>) and programmable conditions (<code>when</code>).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># computed priority</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">pow</span> <span style="color: #000000">mat</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Matrix</span>, <span style="color: #000000">n</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">PositiveInteger</span> 
            <span style="color: #005782">pertinence</span> <span style="color: #6d3642; font-weight: bold">-</span> <span style="color: #000000">cost_mult</span>( <span style="color: #000000">mat</span>, <span style="color: #000000">mat</span> ) <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">log</span> <span style="color: #000000">n</span>
    <span style="color: #000000">n</span> <span style="color: #6d3642; font-weight: bold">&amp;</span> <span style="color: #93488f">1</span> <span style="color: #6d3642; font-weight: bold">?</span> <span style="color: #000000">mat</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">pow</span>( <span style="color: #000000">mat</span>, <span style="color: #000000">n</span> <span style="color: #6d3642; font-weight: bold">-</span> <span style="color: #93488f">1</span> )
          <span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">pow</span>( <span style="color: #000000">mat</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">mat</span>, <span style="color: #000000">n</span> <span style="color: #6d3642; font-weight: bold">/</span> <span style="color: #93488f">2</span> )

<span style="color: #938d7f; font-style: italic"># + computed condition (handled at compile time in this case)</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">pow</span> <span style="color: #000000">mat</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Matrix</span>, <span style="color: #000000">n</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Number</span>
            <span style="color: #005782">when</span> <span style="color: #000000">mat</span>.<span style="color: #000000">sub_types</span>.<span style="color: #000000">some</span>( <span style="color: #000000">T</span> <span style="color: #6d3642; font-weight: bold">=&gt;</span> <span style="color: #000000">T</span>.<span style="color: #000000">is_approximate</span> )
            <span style="color: #005782">pertinence</span> <span style="color: #6d3642; font-weight: bold">-</span> <span style="color: #000000">cost_eigen</span>( <span style="color: #000000">mat</span> )
    <span style="color: #000000">e</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">eigen</span> <span style="color: #000000">mat</span>
    <span style="color: #000000">e</span>.<span style="color: #000000">P</span>.<span style="color: #000000">trans</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">pow</span>( <span style="color: #000000">e</span>.<span style="color: #000000">D</span>, <span style="color: #000000">n</span> ) <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">e</span>.<span style="color: #000000">P</span>
</pre></div>
<h2>Multidimensionnal vtables</h2>

<p>The <code>virtual</code> keyword can work on any kind of argument, indifferently on methods or functions.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># run-time selection using bidimensionnal vtables</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">intersection_area</span> <span style="color: #005782">virtual</span> <span style="color: #000000">a</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Square</span>, <span style="color: #005782">virtual</span> <span style="color: #000000">b</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Triangle</span>
    ...

<span style="color: #938d7f; font-style: italic"># a (dynamic) polymorphic function</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">weight</span> <span style="color: #000000">a</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">GeometricObject</span>, <span style="color: #000000">b</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">GeometricObject</span>, <span style="color: #000000">density</span><span style="color: #6d3642; font-weight: bold">?</span> <span style="color: #93488f">7800</span>
    <span style="color: #000000">density</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">intersection_area</span> <span style="color: #000000">a</span>, <span style="color: #000000">b</span>
</pre></div>
<blockquote>
  <p>(Remark: there are different kinds of vtables in Sane. Adding a pointer at the beginning (for the simple mono-inheritance case) is the default solution -- very good on a general purpose -- but other choices exist)</p>
</blockquote>

<h2>Template classes</h2>

<p><strong>Classes parameters can be of any type</strong>, as long as copy and equality can be Compile-Time handled, in a symbolic way (comparison of graphs) or not (comparison of known values).</p>

<p>This notably does not exclude the types that may imply memory allocation as <code>String</code>, <code>Vec[...]</code>, ... In this case, the comparison are symbolic and can be handled at Compile-Time.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># `sizes` can be defined using any kind of array</span>
<span style="color: #00aaff">class</span> <span style="color: #000000">PoolBySize</span>[ <span style="color: #000000">sizes</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">ArrayLike</span>, <span style="color: #000000">mt</span><span style="color: #6d3642; font-weight: bold">?</span> <span style="color: #005782">true</span>, <span style="color: #000000">name</span><span style="color: #6d3642; font-weight: bold">?</span> <span style="color: #118811">&quot;anon&quot;</span> ]
    <span style="color: #00aaff">class</span> <span style="color: #000000">Item</span>
        <span style="color: #000000">free_ptr</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">NullableAT</span> <span style="color: #938d7f; font-style: italic"># nullable address</span>
        <span style="color: #000000">page_vec</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Vec</span>[ <span style="color: #000000">AT</span> ]  <span style="color: #938d7f; font-style: italic"># contiguous array of addresses</span>
    <span style="color: #938d7f; font-style: italic"># StaticMap constructs a Compile-Time tree</span>
    <span style="color: #000000">map</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">StaticMap</span>[ <span style="color: #000000">sizes</span>, <span style="color: #000000">Item</span> ] 
    ...

<span style="color: #938d7f; font-style: italic"># instantiation for a given set of sizes (handled at CT)</span>
<span style="color: #000000">pool</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">PoolBySize</span>[ [ <span style="color: #93488f">16</span>, <span style="color: #93488f">24</span>, <span style="color: #93488f">32</span> ] ]()
</pre></div>
<h2>Variadic arguments</h2>

<p>Callable parameters (for <code>def</code>, <code>class</code>, <code>=&gt;</code>, ...) can be variadic, with optional constraints. It construct a compile-time known <code>Varargs</code> object, containing the optional names and the argument references.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">a</span>, ...<span style="color: #000000">b</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">SI32</span>, <span style="color: #000000">c</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">StringLike</span>
    <span style="color: #000000">info</span> <span style="color: #000000">a</span>, <span style="color: #000000">b</span>, <span style="color: #000000">c</span>         <span style="color: #938d7f; font-style: italic"># -&gt; 4, [5,arg_name:6], &quot;bar&quot;</span>
    <span style="color: #000000">info</span> <span style="color: #000000">b</span>[ <span style="color: #93488f">0</span> ]          <span style="color: #938d7f; font-style: italic"># -&gt; 5</span>
    <span style="color: #000000">info</span> <span style="color: #000000">b</span>[ <span style="color: #118811">&quot;arg_name&quot;</span> ] <span style="color: #938d7f; font-style: italic"># -&gt; 6</span>
    <span style="color: #000000">info</span> <span style="color: #000000">b</span>.<span style="color: #000000">values</span>        <span style="color: #938d7f; font-style: italic"># -&gt; [5, 6]</span>
    <span style="color: #000000">info</span> <span style="color: #000000">b</span>.<span style="color: #000000">names</span>         <span style="color: #938d7f; font-style: italic"># -&gt; [arg_name]</span>

<span style="color: #000000">foo</span> <span style="color: #93488f">4</span>, <span style="color: #93488f">5</span>, <span style="color: #000000">arg_name</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #93488f">6</span>, <span style="color: #118811">&quot;bar&quot;</span>
</pre></div>
<h2>Spread operator</h2>

<p>The <code>...</code> operator can also be used to expand stuff, notably for calls and list definitions.</p>

<p><code>...</code> works with every kinds of lists containing a compile-time runnable <code>spread</code> method.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># ex. 1: call with an expanded Varargs </span>
<span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">a</span>, ...<span style="color: #000000">b</span>
    <span style="color: #000000">bar</span> ...<span style="color: #000000">b</span>, <span style="color: #93488f">654</span>

<span style="color: #938d7f; font-style: italic"># ex. 2: expansion in a list</span>
<span style="color: #000000">u</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">2</span> .. <span style="color: #93488f">10</span> <span style="color: #938d7f; font-style: italic"># range( 2, 10 )</span>
<span style="color: #000000">v</span> <span style="color: #6d3642; font-weight: bold">:=</span> [ <span style="color: #93488f">1</span>, ...<span style="color: #000000">u</span>, <span style="color: #93488f">10</span> ]
</pre></div>
<p></p>
</section>
<section id="Objects">
<h1>Objects</h1>
<h2>Constructors</h2>

<p>As with C++, constructors allow a <em>pre-construction</em> phase, to initialize attributes only once and directly with the right arguments.</p>

<p>Unlike with C++, pre-construction may occur in a block, <strong>with arbitrary interleaved instructions</strong>.</p>

<p>This block can be delimited explicitly (<code>wpc</code>) or implicitly (the last <em>visible</em> <code>init_of</code> call). <code>init_of attr_name, [ ctor_args ]</code> allows to initialize an argument. <code>init_of self, [ ctor_args ]</code> enables to call another constructor of the same class.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #00aaff">class</span> <span style="color: #000000">MyClass</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">construct</span>
        <span style="color: #938d7f; font-style: italic"># explicit pre-construction block (with interleaved instructions)</span>
        <span style="color: #005782">wpc</span>
            <span style="color: #005782">init_of</span> <span style="color: #000000">a</span>, <span style="color: #93488f">564</span> 
            <span style="color: #000000">z</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">12</span>
            <span style="color: #005782">init_of</span> <span style="color: #000000">b</span>, <span style="color: #93488f">654</span>, <span style="color: #000000">z</span>
        <span style="color: #938d7f; font-style: italic"># -&gt; &quot;normal&quot; construction (*all* arg are now pre-initialized)</span>
        <span style="color: #000000">print</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">b</span>

    <span style="color: #938d7f; font-style: italic"># equivalent ctor with automatic wpc block</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">construct</span>
        <span style="color: #938d7f; font-style: italic"># implicit pre-construction block</span>
        <span style="color: #005782">init_of</span> <span style="color: #000000">a</span>, <span style="color: #93488f">564</span> 
        <span style="color: #000000">z</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">12</span>
        <span style="color: #005782">init_of</span> <span style="color: #000000">b</span>, <span style="color: #93488f">654</span>, <span style="color: #000000">z</span>
        <span style="color: #938d7f; font-style: italic"># -&gt; &quot;normal&quot; construction (*all* arg are now pre-initialized)</span>
        <span style="color: #000000">print</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">b</span>

    <span style="color: #938d7f; font-style: italic"># wpc allows for the use of arbitrarily complex interleaved instructions</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">construct</span>
        <span style="color: #005782">wpc</span>
            <span style="color: #000000">u</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">7</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">5</span> 
            <span style="color: #005782">for</span> <span style="color: #000000">n</span> <span style="color: #005782">in</span> <span style="color: #118811">&quot;ab&quot;</span>
                <span style="color: #005782">init_of</span> <span style="color: #000000">$n</span>, <span style="color: #93488f">654</span>, <span style="color: #000000">u</span>
            <span style="color: #000000">my_c_init</span>()

    <span style="color: #00aaff">def</span> <span style="color: #000000">my_c_init</span>
        <span style="color: #005782">init_of</span> <span style="color: #000000">c</span>, <span style="color: #93488f">564</span> <span style="color: #938d7f; font-style: italic"># (this instruction forces the inlining of my_c_init)</span>

    <span style="color: #000000">a</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Foo</span>
    <span style="color: #000000">b</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Bar</span>
    <span style="color: #000000">c</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Baz</span>
</pre></div>
<h2>Getsetters</h2>

<p><em>Symbolic attributes</em> can be added using <code>get_...</code>, <code>set_...</code>, <code>mod_...</code> and <code>typeof_...</code> method names.</p>

<!-- Getters and setters globally enable a wide reduction of parenthesis bloating. More importantly, it helps to write more polymorphic, encapsulated and generic code. -->
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># an example with getters and setters</span>
<span style="color: #00aaff">class</span> <span style="color: #000000">Complex</span>[ <span style="color: #000000">T</span><span style="color: #6d3642; font-weight: bold">?</span> <span style="color: #000000">FP32</span> ]
    <span style="color: #00aaff">def</span> <span style="color: #000000">get_mag</span>
        <span style="color: #000000">sqrt</span> <span style="color: #000000">real</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">real</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">imag</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">imag</span>

    <span style="color: #00aaff">def</span> <span style="color: #000000">get_arg</span>
        <span style="color: #000000">atan2</span> <span style="color: #000000">imag</span>, <span style="color: #000000">real</span>

    <span style="color: #00aaff">def</span> <span style="color: #000000">set_mag</span> <span style="color: #000000">new_mag</span>
        <span style="color: #000000">old_arg</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">arg</span>
        <span style="color: #000000">real</span> <span style="color: #6d3642; font-weight: bold">=</span> <span style="color: #000000">new_mag</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">cos</span> <span style="color: #000000">old_arg</span>
        <span style="color: #000000">imag</span> <span style="color: #6d3642; font-weight: bold">=</span> <span style="color: #000000">new_mag</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">sin</span> <span style="color: #000000">old_arg</span>
        
    <span style="color: #000000">real</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">T</span>
    <span style="color: #000000">imag</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">T</span>

<span style="color: #000000">c</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">Complex</span> <span style="color: #93488f">1</span>, <span style="color: #93488f">2</span>
<span style="color: #000000">info</span> <span style="color: #000000">c</span>.<span style="color: #000000">mag</span> <span style="color: #938d7f; font-style: italic"># =&gt; 2.24</span>
<span style="color: #000000">c</span>.<span style="color: #000000">mag</span> <span style="color: #6d3642; font-weight: bold">=</span> <span style="color: #93488f">4</span>  <span style="color: #938d7f; font-style: italic"># =&gt; calls set_mod( 4 )</span>
</pre></div>
<p><code>typeof_...</code> allows to get type information without the need for a getter (can be useful for pure <code>set</code>ters or <code>mod</code>ers).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #00aaff">class</span> <span style="color: #000000">Smurf</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">typeof_break_dance</span>
        <span style="color: #000000">SI32</span>

    <span style="color: #00aaff">def</span> <span style="color: #000000">set_break_dance</span> <span style="color: #000000">value</span>
        <span style="color: #000000">info</span> <span style="color: #000000">value</span>

<span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">v</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">SI32</span>
    <span style="color: #000000">v</span> <span style="color: #6d3642; font-weight: bold">=</span> <span style="color: #93488f">654</span>

<span style="color: #000000">s</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">Smurf</span>()
<span style="color: #000000">foo</span> <span style="color: #000000">s</span>.<span style="color: #000000">break_dance</span> <span style="color: #938d7f; font-style: italic"># will work (typeof is known without a getter)</span>
</pre></div>
<p><code>mod_...</code> can be seen as a generalized <code>set</code>ter. It is called with a modifying function as parameter (instead of a value).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># an example with getters and setters</span>
<span style="color: #00aaff">class</span> <span style="color: #000000">NodeList</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">mod_x</span> <span style="color: #000000">func</span>
        <span style="color: #005782">for</span> <span style="color: #000000">p</span> <span style="color: #005782">in</span> <span style="color: #000000">points</span>
            <span style="color: #000000">func</span> <span style="color: #000000">p</span>.<span style="color: #000000">x</span>
    <span style="color: #000000">points</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Vec</span>[ <span style="color: #000000">Point</span> ]

<span style="color: #000000">node_list</span>.<span style="color: #000000">x</span> <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #93488f">10</span> <span style="color: #938d7f; font-style: italic"># &#39;operator+=&#39; is a register &quot;mod function&quot;</span>
</pre></div>
<p></p>
</section>
<section id="Typesforliterals">
<h1>Types for literals</h1>
<p>Literals (<code>12</code>, <code>"smurf"</code>, <code>[1,2]</code>, ...) must be of given types, but it's impossible to find types that would directly fit all the needs (one day you need fast coding, on another day you will have to focus on execution speed, security, etc...).</p>

<p>Sane tries then to provide types to fit the most common needs, with maximum flexibility and able to execute the most common operations at good <em>mean</em> speeds and memory occupancy, while <strong>fully ensuring that the conversion costs will be zero</strong>.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># generates a mutable &#39;String&#39;</span>
<span style="color: #000000">s</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #118811">&quot;les { 2 * 4 } scarole&quot;</span>

<span style="color: #938d7f; font-style: italic"># supporting common operations</span>
<span style="color: #938d7f; font-style: italic"># (with potential memory allocation)</span>
<span style="color: #000000">s</span> <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #118811">&quot;s&quot;</span>

<span style="color: #938d7f; font-style: italic"># operations can nevertheless be handled by the compiler,</span>
<span style="color: #938d7f; font-style: italic"># enabling to remove intermediate memory allocation. t</span>
<span style="color: #938d7f; font-style: italic"># will be stored in the .text or .data section with a</span>
<span style="color: #938d7f; font-style: italic"># zero-cost execution</span>
<span style="color: #000000">t</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">StaticCString</span> <span style="color: #000000">s</span>

<span style="color: #938d7f; font-style: italic"># and now, we have a pointer on a zero-ended string</span>
<span style="color: #000000">strlen</span> <span style="color: #000000">t</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">2</span> <span style="color: #938d7f; font-style: italic"># returns s.length - 2</span>
</pre></div>
<p>For maximum flexibility, arrays are fully generic</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># heterogeneous arrays (no forced conversion)</span>
<span style="color: #005782">for</span> <span style="color: #000000">a</span> <span style="color: #005782">in</span> [ <span style="color: #118811">&quot;f&quot;</span>, <span style="color: #93488f">1</span> ]; <span style="color: #000000">print</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">1</span> <span style="color: #938d7f; font-style: italic"># -&gt; f1 2 </span>
<span style="color: #938d7f; font-style: italic"># costlesss conversions (using a std lib function)</span>
<span style="color: #005782">for</span> <span style="color: #000000">a</span> <span style="color: #005782">in</span> <span style="color: #000000">vec</span> [ <span style="color: #118811">&quot;f&quot;</span>, <span style="color: #93488f">1</span> ]; <span style="color: #000000">print</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">1</span> <span style="color: #938d7f; font-style: italic"># -&gt; f1 11 </span>
<span style="color: #938d7f; font-style: italic"># choice of the target type</span>
<span style="color: #005782">for</span> <span style="color: #000000">a</span> <span style="color: #005782">in</span> <span style="color: #000000">Vec</span>[ <span style="color: #000000">String</span> ] [ <span style="color: #118811">&quot;f&quot;</span>, <span style="color: #93488f">1</span> ]; <span style="color: #000000">print</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">1</span> <span style="color: #938d7f; font-style: italic"># -&gt; f1 11</span>
</pre></div>
<p>Maps have followed the same path.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># works the same way for maps</span>
<span style="color: #005782">import</span> <span style="color: #000000">HashTable</span>

<span style="color: #000000">v</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">17</span>
<span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">:=</span> { <span style="color: #93488f">1</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #93488f">2</span>, <span style="color: #118811">&quot;f&quot;</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #118811">&quot;g&quot;</span>, <span style="color: #000000">v</span> } <span style="color: #938d7f; font-style: italic"># &lt;=&gt; &quot;v&quot;: v for the last item</span>
<span style="color: #938d7f; font-style: italic"># can be converted with compile time support</span>
<span style="color: #000000">info</span> <span style="color: #000000">HashTable</span>[ <span style="color: #000000">String</span>, <span style="color: #000000">String</span> ] <span style="color: #000000">a</span> <span style="color: #938d7f; font-style: italic"># -&gt; { &quot;1&quot;: &quot;2&quot;, &quot;f&quot;: &quot;g&quot;, &quot;v&quot;: &quot;17&quot; }</span>
</pre></div>
<p>(Remark: <code>{}</code> may allow to define JS-like objects, using the function <code>obj</code>. In Sane, keys are computed value, whence the need for double quotes as in JSON.)</p>
</section>
<section id="Memory">
<h1>Memory</h1>
<h2>Rvalues</h2>

<p><code>rvalue</code> allows to know if a value is <em>owned</em> on a given scope.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">a</span>, <span style="color: #000000">b</span>
    <span style="color: #000000">info</span> <span style="color: #000000">rvalue</span> <span style="color: #000000">a</span> <span style="color: #938d7f; font-style: italic"># -&gt; true (s + 2 has been created for the call and will be destroyed just after)</span>
    <span style="color: #000000">info</span> <span style="color: #000000">rvalue</span> <span style="color: #000000">b</span> <span style="color: #938d7f; font-style: italic"># -&gt; false (b is a reference on a variable referenced elsewhere)</span>

<span style="color: #000000">s</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #118811">&quot;...&quot;</span>
<span style="color: #000000">foo</span> <span style="color: #000000">s</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">2</span>, <span style="color: #000000">s</span>
</pre></div>
<p><code>move x</code> create a new object, with the resources of <code>x</code> (<code>y := move x</code> moves the resources of <code>x</code> to a new object <code>y</code> of the same type).</p>

<p>Besides, <code>forward x</code> is equivalent to <code>move x</code> if <code>x</code> is an rvalue. In the other case, it returns the reference on <code>x</code>.</p>

<!-- Besides, Sane automates the "last usage tracking" of mutable variables (using the Abstract Syntax Tree). Variables  -->
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">v</span>
    <span style="color: #000000">info</span> <span style="color: #000000">rvalue</span> <span style="color: #000000">v</span>
    <span style="color: #000000">w</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">Vec</span>[ <span style="color: #000000">SI32</span> ] <span style="color: #000000">forward</span> <span style="color: #000000">v</span> <span style="color: #938d7f; font-style: italic"># content of v will be transfered (not copied) to w if v is a rvalue</span>

<span style="color: #000000">v</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">vec</span> [ <span style="color: #93488f">1</span>, <span style="color: #93488f">2</span>, <span style="color: #93488f">3</span> ]
<span style="color: #000000">foo</span> <span style="color: #000000">v</span>      <span style="color: #938d7f; font-style: italic"># rvalue: false. Content of v will be copied (with a potential mem alloc)</span>
<span style="color: #000000">foo</span> <span style="color: #000000">move</span> <span style="color: #000000">v</span> <span style="color: #938d7f; font-style: italic"># rvalue: true.  No copy, no mem alloc</span>
</pre></div>
<h2>Heap</h2>

<p>Variables can of course be created on the heap, with the (heap or mixed) allocator of your choice. <code>new</code> and <code>delete</code> are regular standard functions (not operators) that use a slub allocator (modifiable globally if wanted) but that can be surdefined, locally or globally.</p>

<p>Besides, it is common to use different allocators in different parts of the programs (e.g. with calls like <code>my_allocator.new Type[, ctor_args]</code>. That's one on the reason why <code>new</code> and <code>delete</code> are regular functions.</p>

<h2>Stack(s)</h2>

<p>If not specified, variables are of course created on <em>a</em> stack. By default, variables are created on the <em>current</em> stack. Nevertheless, as an optimization, if they are intended to be returned or used elsewhere, they can be created directly on a parent stack.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #00aaff">def</span> <span style="color: #000000">foo</span>
    <span style="color: #000000">vec</span> <span style="color: #93488f">0</span> .. <span style="color: #93488f">1</span><span style="color: #000000">e6</span>
<span style="color: #938d7f; font-style: italic"># the vector &#39;vec 0 .. 1e6&#39; is directly created </span>
<span style="color: #938d7f; font-style: italic"># in the stack of a, not in the stack of foo</span>
<span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">foo</span>()
</pre></div>
<!-- Internally, stack variable are handled with a ref counter, intended -->

<h2>Notations for references and pointers</h2>

<p>For faster reading (and conformance with the base syntax), pointers and references have the specific signs.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># new is a regular function (explaining the &#39;,&#39; after the type)</span>
<span style="color: #000000">p</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">new</span> <span style="color: #000000">String</span>, <span style="color: #118811">&quot;123&quot;</span> <span style="color: #938d7f; font-style: italic"># -&gt; type = Ptr[ String ]</span>
<span style="color: #938d7f; font-style: italic"># &#39;@&#39; allows to get the references</span>
<span style="color: #000000">info</span> @<span style="color: #000000">p</span>
<span style="color: #938d7f; font-style: italic"># &#39;-&gt;&#39; works as usual</span>
<span style="color: #000000">info</span> <span style="color: #000000">p</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">size</span>
<span style="color: #938d7f; font-style: italic"># &#39;\&#39; allows to get a pointer</span>
<span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #118811">&quot;456&quot;</span>
<span style="color: #000000">q</span> <span style="color: #6d3642; font-weight: bold">:=</span> \<span style="color: #000000">a</span> <span style="color: #938d7f; font-style: italic"># -&gt; a Ptr[ String ] pointing to a</span>
</pre></div>
<p></p>
</section>
<section id="Generativeprogramming">
<h1>Generative programming</h1>
<p>Of course, Sane can profitably be used to generate code formatted in strings, to be included in a second compilation phase...</p>

<p>Nevertheless, as we will see below, the Sane compiler is able to <strong>execute and cache the result of any Sane code during the compilation</strong>. It opens up an important set of new possibilities, providing access to more flexibility, clarity and efficiency.</p>

<h2>Compile-time execution</h2>

<p>The Sane compiler executes code during the compilation</p>

<ul>
<li>if explicitly required (via for instance <code>kv</code> function),</li>
<li>if mandatory (notably for template parameters, computed names, ...),</li>
<li>or if trivial (simplifications that do not penalize the compilation time)</li>
</ul>

<p>Of course, compile-time execution is not allowed to work on data intended to be handled at run-time (e.g. files, unless explicitly stated).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># a good portion of the CT simplifications are automatic </span>
<span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">:=</span> [ <span style="color: #93488f">1</span>, <span style="color: #93488f">2</span>, <span style="color: #93488f">3</span> ].<span style="color: #000000">size</span>
<span style="color: #005782">if</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">!=</span> <span style="color: #93488f">3</span>
    <span style="color: #000000">never_compiled</span>() <span style="color: #938d7f; font-style: italic"># because size is trivially known at CT</span>

<span style="color: #938d7f; font-style: italic"># they can also be triggered explicitly (`kv` function)</span>
<span style="color: #000000">b</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">0</span>
<span style="color: #005782">for</span> <span style="color: #000000">i</span> <span style="color: #005782">in</span> <span style="color: #93488f">0</span> .. <span style="color: #93488f">10</span>
    <span style="color: #000000">b</span> <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #000000">i</span>
<span style="color: #005782">if</span> <span style="color: #000000">kv</span> <span style="color: #000000">b</span> <span style="color: #6d3642; font-weight: bold">!=</span> <span style="color: #93488f">45</span> <span style="color: #938d7f; font-style: italic"># at CT, b is symbolic, but kv( b ) is known</span>
    <span style="color: #000000">never_compiled</span>()

<span style="color: #938d7f; font-style: italic"># if explicitly stated, it can work with files</span>
<span style="color: #000000">c</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">load</span>( <span style="color: #118811">&quot;fs&quot;</span> ).<span style="color: #000000">read_file_sync</span> <span style="color: #118811">&quot;my_file&quot;</span>, <span style="color: #000000">kv</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #005782">true</span>
<span style="color: #000000">s</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">c</span>.<span style="color: #000000">split</span>().<span style="color: #000000">filter</span>( <span style="color: #000000">x</span> <span style="color: #6d3642; font-weight: bold">=&gt;</span> <span style="color: #000000">x</span>.<span style="color: #000000">size</span> <span style="color: #6d3642; font-weight: bold">==</span> <span style="color: #93488f">3</span> ).<span style="color: #000000">size</span>
<span style="color: #000000">info</span> <span style="color: #000000">kv</span> <span style="color: #000000">s</span> <span style="color: #938d7f; font-style: italic"># computed entirely at CT</span>

<span style="color: #938d7f; font-style: italic"># triggering can be implicitly </span>
<span style="color: #000000">i</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">MyClass</span>[ <span style="color: #000000">s</span> ] <span style="color: #938d7f; font-style: italic"># we store the symbolic repr (no need at this stage to get the value)</span>
<span style="color: #000000">j</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">MyClass</span>[ <span style="color: #93488f">17</span> ] <span style="color: #938d7f; font-style: italic"># here, the equality operator (s==?17) forces the computation</span>
</pre></div>
<!-- Generative Programming involves generally programs that generate programs. In lot of cases, the point is to ensure that some computations are done before runtime, notably for performance, syntax, factorizations, interoperability...

When programs for code generation are separate from the program to be finally executed, one could use the term external code generation. External code generation is an obvious and very flexible, but generally leads to uncomfortable maintainability issues (problems with tracing, with clarity, with builders generally not designed for that, ...).

With the handling of compile time computations, Sane provides tools for embedded code generation. In enables the largest scope of possibilities while leading code far clearer and easier to maintain. -->

<h2>Computed names</h2>

<p>All variable names (whether it's for look up or for creation) may be computed (using <code>$</code>s).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># creation and use of a variable named &#39;i18&#39;</span>
<span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">9</span>
<span style="color: #000000">i$</span>( <span style="color: #93488f">2</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">a</span> )<span style="color: #000000">n</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">43</span>
<span style="color: #000000">info</span> <span style="color: #000000">$</span>( <span style="color: #118811">&quot;hij&quot;</span>[<span style="color: #93488f">1</span>] )<span style="color: #93488f">18</span> <span style="color: #938d7f; font-style: italic"># =&gt; 43</span>
</pre></div>
<h2>Creation in parent scopes</h2>

<p>A <code>\</code> in a variable declaration enables to declare it in a parent scope (<code>\</code> for the first parent, <code>\\</code> for the second one, ...). It works also in class block (notably to define methods and attributes, static or dynamic) which can actually be a place  where any kind of code is executed (Sane use the variables in the scope to determine attributes and methods).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># This is (an extract of) the class used for enums is the std libraries</span>
<span style="color: #00aaff">class</span> <span style="color: #000000">Enum</span>[ <span style="color: #000000">id</span>, <span style="color: #000000">item_names</span> ]
    <span style="color: #938d7f; font-style: italic"># class blocks are executed only once (for a set of template parameters)</span>
    <span style="color: #005782">static</span> <span style="color: #000000">__nb_items</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">0</span>
    <span style="color: #005782">for</span> <span style="color: #000000">name</span> <span style="color: #005782">in</span> <span style="color: #000000">item_names</span> 
        <span style="color: #000000">num</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">post_inc</span> <span style="color: #000000">__nb_items</span>
        <span style="color: #005782">static</span> <span style="color: #938d7f; font-style: italic"># (works also with non-static defs and attrs)</span>
        <span style="color: #00aaff">def</span> \<span style="color: #000000">get_$name</span>
            <span style="color: #000000">Enum</span>[ <span style="color: #000000">id</span>, <span style="color: #000000">name</span>, <span style="color: #000000">item_names</span> ] <span style="color: #000000">__value</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">num</span>

    <span style="color: #00aaff">def</span> <span style="color: #000000">write_to_stream</span> <span style="color: #000000">os</span> 
        <span style="color: #000000">os</span> <span style="color: #6d3642; font-weight: bold">&lt;&lt;</span> <span style="color: #000000">item_names</span>[ <span style="color: #000000">__value</span> ]

    <span style="color: #000000">__value</span> <span style="color: #6d3642; font-weight: bold">~=</span> <span style="color: #000000">SI32</span>
      
<span style="color: #000000">T</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">Enum</span>[ <span style="color: #93488f">0</span>, [ <span style="color: #118811">&quot;A&quot;</span>, <span style="color: #118811">&quot;B&quot;</span> ] ]
<span style="color: #000000">info</span> <span style="color: #000000">T</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">A</span> <span style="color: #938d7f; font-style: italic"># =&gt; A (thanks to the generated `static def get_A` in the class scope)</span>
</pre></div>
<h2>Compile-time Symbolic computations</h2>

<p>Sane enables to handle SSA (Single Static Assignment) trees at compile-time.</p>

<p>It is for instance possible to get a representation of what a function or a block does. Trees can be filtered (transformations) or created <em>ab anitio</em>. They can then be passed back to the compiler which will be able to generate tuned and optimized code from this representation.</p>

<p>Here is a (simplified) example of automatic optimized differentiation.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># extract of a function to differentiate at a graph level</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">ssa_diff</span> <span style="color: #000000">node</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">SsaGraph</span>
    <span style="color: #000000">switch</span> <span style="color: #000000">node</span>
        <span style="color: #000000">Symbolic</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">mul</span> <span style="color: #6d3642; font-weight: bold">==&gt;</span> <span style="color: #000000">node</span>.<span style="color: #000000">children</span>[ <span style="color: #93488f">0</span> ] <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">ssa_diff</span> <span style="color: #000000">node</span>.<span style="color: #000000">children</span>[ <span style="color: #93488f">1</span> ] <span style="color: #6d3642; font-weight: bold">+</span>
                          <span style="color: #000000">node</span>.<span style="color: #000000">children</span>[ <span style="color: #93488f">1</span> ] <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">ssa_diff</span> <span style="color: #000000">node</span>.<span style="color: #000000">children</span>[ <span style="color: #93488f">0</span> ] 
        ... 

<span style="color: #938d7f; font-style: italic"># a simple function</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">foo</span> <span style="color: #000000">n</span>, <span style="color: #000000">x</span>
    <span style="color: #000000">res</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">typeof</span>( <span style="color: #000000">x</span> ) <span style="color: #93488f">0</span>
    <span style="color: #005782">for</span> <span style="color: #000000">i</span> <span style="color: #005782">in</span> <span style="color: #93488f">1</span> .. <span style="color: #000000">n</span>
        <span style="color: #000000">res</span> <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #000000">pow</span> <span style="color: #000000">x</span>, <span style="color: #000000">i</span>
    <span style="color: #000000">res</span>

<span style="color: #938d7f; font-style: italic"># graph representation + differentiation of foo</span>
<span style="color: #000000">x</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">ct_symbol</span> <span style="color: #000000">FP64</span>
<span style="color: #000000">n</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">ct_symbol</span> <span style="color: #000000">SI32</span>
<span style="color: #000000">sym_diff</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">ssa_diff</span> <span style="color: #000000">ct_graph</span>( <span style="color: #000000">foo</span>( <span style="color: #000000">x</span>, <span style="color: #000000">n</span> ) ), <span style="color: #000000">x</span>

<span style="color: #938d7f; font-style: italic"># compile time optimized differentiation of foo</span>
<span style="color: #000000">foo_diff</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">sym_diff</span>.<span style="color: #000000">subs</span> [ <span style="color: #000000">x</span>, <span style="color: #000000">n</span> ], [ <span style="color: #000000">xv</span>, <span style="color: #000000">nv</span> ]
</pre></div>
<p>These symbolic representations can be seen as the level above the AST representation (also accessible via std introspection as shown later). They enable what one can call "code introspection and filtering".</p>

<p>It is for instance used in the module <code>vectorize</code> (providing ways to simplify the writing of loops with SIMD instructions). In all the cases, transformations are triggered by standard calls and are a library concern (meaning that you have the choice to select them, to modify or create new ones for full control and extensibility).</p>

<h2>Compile-time evaluation</h2>

<p>For the extreme cases, it is possible to pass an arbitrary string to the compiler (as long of course as it can be CT computed).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">5</span>
<span style="color: #000000">ct_eval</span> <span style="color: #118811">&quot;def foo; </span>${ <span style="color: #93488f">1</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">a</span> }<span style="color: #118811">&quot;</span>
<span style="color: #000000">info</span> <span style="color: #000000">foo</span>() <span style="color: #938d7f; font-style: italic"># =&gt; 6</span>
</pre></div>
<blockquote>
  <p>This construction is probably the closest to the one we can find in "code generation", with a reduction of problems coming from information scattering and tangled build configuration. Nevertheless, computed names with CT branching usually offer superior clarity and debugging support.</p>
</blockquote>

<h2>Ab initio primitives</h2>

<p>In the same vein, it is possible to handle structures instead of text (as e.g. handling a DOM vs the html text).</p>

<p>Almost every objects handled by the compiler is actually accessible and modifiable within the language. It's valid for types, scopes, definition of methods, classes, and so on.</p>

<p>Compilation objects can for instance be created <em>ab initio</em>, to be consecutively handled by the compiler.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># creation</span>
<span style="color: #000000">T</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">Type</span>()
<span style="color: #000000">T</span>.<span style="color: #000000">name</span> <span style="color: #6d3642; font-weight: bold">=</span> <span style="color: #118811">&quot;MyType&quot;</span>
<span style="color: #000000">T</span>.<span style="color: #000000">attributes</span> <span style="color: #6d3642; font-weight: bold">&lt;&lt;</span> <span style="color: #000000">Type</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">Attribute</span> <span style="color: #000000">off</span><span style="color: #6d3642; font-weight: bold">:</span><span style="color: #93488f">0</span>, <span style="color: #000000">name</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #118811">&quot;a&quot;</span>, <span style="color: #000000">type</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">SI32</span>

<span style="color: #938d7f; font-style: italic"># the created type is stored and handled exactly like the others</span>
<span style="color: #000000">i</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">T</span> <span style="color: #000000">a</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #93488f">100</span>
<span style="color: #000000">info</span> <span style="color: #000000">i</span> <span style="color: #938d7f; font-style: italic"># =&gt; T( a: 100 )</span>
</pre></div>
<p></p>
</section>
<section id="Activelibraries">
<h1>Active libraries</h1>
<h2>Selection</h2>

<p>In Sane, functions implementations can be selected according to their <em>a posteriori</em> usage, notably to allow <em>global optimizations</em>.</p>

<p>When functions (or methods) that are qualified <code>switchable</code> are called, Sane marks them in the generated graph (which includes the captured variables). Before code emission, these marks are sent to the registered "switch procedures", allowing to <strong>choose the best implementations</strong> depdending on the global context.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># a standard matrix class (with a `switchable` procedure)</span>
<span style="color: #00aaff">class</span> <span style="color: #000000">Matrix</span>
    <span style="color: #005782">switchable</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">operator</span><span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">that</span>
        <span style="color: #938d7f; font-style: italic"># -&gt; normal multiplication procedure</span>
    ...

<span style="color: #938d7f; font-style: italic"># standard multiplications (left to right)</span>
<span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">p</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">q</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">r</span> <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">v</span>

<span style="color: #938d7f; font-style: italic"># addition of a &quot;switcher&quot; (a different implementation, providing the same result)</span>
<span style="color: #938d7f; font-style: italic"># to call a procedure able to find the best ways to do the multiplications</span>
<span style="color: #000000">globals</span>.<span style="color: #000000">switchers</span>.<span style="color: #000000">add</span>
    <span style="color: #000000">oper</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">Matrix</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">operator</span><span style="color: #6d3642; font-weight: bold">*</span>
    <span style="color: #000000">func</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">inps</span>, <span style="color: #000000">outs</span> <span style="color: #6d3642; font-weight: bold">=&gt;</span>
        <span style="color: #938d7f; font-style: italic"># (simplified code)</span>
        <span style="color: #000000">mults</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">get_mults_rec</span> <span style="color: #000000">inps</span>
        <span style="color: #000000">best_split</span> <span style="color: #6d3642; font-weight: bold">:=</span> ...
        <span style="color: #005782">return</span> <span style="color: #000000">mul</span>( <span style="color: #000000">mults</span>[ <span style="color: #93488f">0</span> .. <span style="color: #000000">best_split</span> ] ) <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">mul</span>( <span style="color: #000000">mults</span>[ <span style="color: #000000">best_split</span>.... ] )
</pre></div>
<p>These possibilities are used in a lot of essential optimizations. For instance, the concatenation operator works only with two variables (because it is an operator). If we want to concatenate more than two variables using this operator, we may end up with a lot of intermediate allocations and copies. A posteriori selection enable to gather the concatenations to avoid the waste.</p>
</section>
<section id="Examplesofactivelibraries">
<h1>Examples of active libraries</h1>
<h2>Auto-tuning</h2>

<p><code>AutoTune</code> is an <em>experimental</em> module that helps to find sets of compile-time variables that minimize a given set of functions.</p>

<p>It uses the fact that Sane is able to compile and execute code in the middle of another compilation (+ use of graphs and caches).</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #005782">import</span> <span style="color: #000000">AutoTune</span>

<span style="color: #938d7f; font-style: italic"># a function with internal tunable parameters</span>
<span style="color: #938d7f; font-style: italic"># (contains only a subset of the optimizations</span>
<span style="color: #938d7f; font-style: italic"># to be made on a dot function)</span>
<span style="color: #00aaff">def</span> <span style="color: #000000">dot</span> <span style="color: #000000">a</span>, <span style="color: #000000">b</span>
    <span style="color: #000000">ule</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">AutoTune</span>.<span style="color: #000000">parameter</span> [ <span style="color: #93488f">2</span>, <span style="color: #93488f">4</span>, <span style="color: #93488f">8</span> ]
    <span style="color: #000000">res</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">Vec</span>[ <span style="color: #000000">typeof</span>( <span style="color: #000000">a</span> ), <span style="color: #000000">ule</span> ] <span style="color: #93488f">0</span>
    <span style="color: #005782">for</span> <span style="color: #000000">c</span> <span style="color: #005782">in</span> <span style="color: #000000">by_chunks</span> <span style="color: #93488f">0</span> .. <span style="color: #000000">a</span>.<span style="color: #000000">size</span>, <span style="color: #000000">ule</span>
        <span style="color: #005782">for</span> <span style="color: #000000">j</span> <span style="color: #005782">in</span> <span style="color: #000000">unrolled</span> <span style="color: #93488f">0</span> .. <span style="color: #000000">c</span>.<span style="color: #000000">size</span>
            <span style="color: #000000">res</span>[ <span style="color: #000000">j</span> ] <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #000000">a</span>[ <span style="color: #000000">c</span>[ <span style="color: #000000">j</span> ] ] <span style="color: #6d3642; font-weight: bold">*</span> <span style="color: #000000">b</span>[ <span style="color: #000000">c</span>[ <span style="color: #000000">j</span> ] ]
    <span style="color: #000000">res</span>.<span style="color: #000000">sum</span>

<span style="color: #938d7f; font-style: italic"># make a tuned version of &#39;dot&#39; for a given set of representative parameters.</span>
<span style="color: #938d7f; font-style: italic"># &#39;va&#39; is a function that constructs a Varargs from its arguments</span>
<span style="color: #000000">t_dot</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">AutoTune</span>.<span style="color: #000000">tuned</span> <span style="color: #000000">dot</span>, [ {
    <span style="color: #118811">&quot;pond&quot;</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #93488f">1</span>, <span style="color: #118811">&quot;args&quot;</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">va</span> <span style="color: #000000">vec</span>( <span style="color: #93488f">1</span> .. <span style="color: #93488f">1000</span> ), <span style="color: #000000">vec</span>( <span style="color: #93488f">1</span> .. <span style="color: #93488f">1000</span> )
} ]

<span style="color: #938d7f; font-style: italic"># &#39;t_dot&#39; is the same thing as &#39;dot&#39; with an optimized set of parameters</span>
<span style="color: #000000">info</span> <span style="color: #000000">t_dot</span> <span style="color: #000000">vec</span>( <span style="color: #93488f">1</span> .. <span style="color: #93488f">1000</span> ), <span style="color: #000000">vec</span>( <span style="color: #93488f">1</span> .. <span style="color: #93488f">1000</span> )
</pre></div>
<h2>Compact representations</h2>

<p>Memory representation or potentially mutable variables are rarely compact. For instance, a <code>String</code> will take at least 24 bytes (on a 64 bits machine) even of the string is very small, a lot of small numbers are stored in too wide integers, etc...</p>

<p>But one can use introspection and generative programming to generate and handle compact representations.</p>

<p>In the following example, we use <code>operator mem_size</code>, which is an optional static method. Its mission is to compute the memory footprint of an instance (in bits), given a pointer to its start.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #938d7f; font-style: italic"># generates a class to handle compact representation of T</span>
<span style="color: #938d7f; font-style: italic"># For the sake of simplicity, this class works with bytes</span>
<span style="color: #938d7f; font-style: italic"># and there&#39;s no ctor nor setters.</span>
<span style="color: #938d7f; font-style: italic"># This is the generic version</span>
<span style="color: #00aaff">class</span> <span style="color: #000000">CompactRepr</span>[ <span style="color: #000000">T</span> ]
    <span style="color: #938d7f; font-style: italic"># method to compute offset of a given attribute</span>
    <span style="color: #005782">static</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">offset_of</span> <span style="color: #000000">base_ptr</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">AT</span>, <span style="color: #000000">name</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">StringLike</span>
        <span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">orp</span>
        <span style="color: #005782">for</span> <span style="color: #000000">attr</span> <span style="color: #005782">in</span> <span style="color: #000000">T</span>.<span style="color: #000000">attributes</span>
            <span style="color: #005782">if</span> <span style="color: #000000">attr</span>.<span style="color: #000000">name</span> <span style="color: #6d3642; font-weight: bold">==</span> <span style="color: #000000">name</span>
                <span style="color: #005782">break</span>
            <span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">+=</span> ( <span style="color: #93488f">7</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">CompactRepr</span>[ <span style="color: #000000">attr</span>.<span style="color: #000000">type</span> ]<span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">operator</span> <span style="color: #000000">mem_size</span> <span style="color: #000000">ptr</span> ) <span style="color: #6d3642; font-weight: bold">//</span> <span style="color: #93488f">8</span>
        <span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">-</span> <span style="color: #000000">this</span>.<span style="color: #000000">val</span>

    <span style="color: #938d7f; font-style: italic"># method to compute memory footprint</span>
    <span style="color: #005782">static</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">operator</span> <span style="color: #000000">mem_size</span> <span style="color: #000000">base_ptr</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">AT</span>
        <span style="color: #000000">offset_of</span> <span style="color: #000000">base_ptr</span>, <span style="color: #118811">&quot;-&quot;</span>

    <span style="color: #938d7f; font-style: italic"># make the getters</span>
    <span style="color: #005782">for</span> <span style="color: #000000">attr</span> <span style="color: #005782">in</span> <span style="color: #000000">T</span>.<span style="color: #000000">attributes</span>
        <span style="color: #00aaff">def</span> \<span style="color: #000000">get_$</span>( <span style="color: #000000">attr</span>.<span style="color: #000000">name</span> )
            @<span style="color: #000000">reinterpret_cast</span> <span style="color: #000000">Ptr</span>[ <span style="color: #000000">CompactRepr</span>[ <span style="color: #000000">attr</span>.<span style="color: #000000">type</span> ] ], <span style="color: #000000">this</span>.<span style="color: #000000">val</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">kv</span> <span style="color: #000000">offset_of</span> <span style="color: #000000">this</span>.<span style="color: #000000">val</span>, <span style="color: #000000">attr</span>.<span style="color: #000000">name</span>

<span style="color: #938d7f; font-style: italic"># surdefinition for positive integers (VLQ)</span>
<span style="color: #00aaff">class</span> <span style="color: #000000">CompactRepr</span>[ <span style="color: #000000">T</span> ] <span style="color: #005782">when</span> <span style="color: #000000">T</span>.<span style="color: #000000">inherits</span>( <span style="color: #000000">Number</span> ) <span style="color: #6d3642; font-weight: bold">&amp;&amp;</span> <span style="color: #000000">T</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">is_integer</span> <span style="color: #6d3642; font-weight: bold">&amp;&amp;</span> <span style="color: #000000">T</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">is_signed</span> <span style="color: #6d3642; font-weight: bold">==</span> <span style="color: #005782">false</span>
    <span style="color: #938d7f; font-style: italic"># method to compute memory footprint</span>
    <span style="color: #005782">static</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">operator</span> <span style="color: #000000">mem_size</span> <span style="color: #000000">base_ptr</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">AT</span>
        <span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">reinterpret_cast</span> <span style="color: #000000">Ptr</span>[ <span style="color: #000000">PI8</span> ], <span style="color: #000000">base_ptr</span>
        <span style="color: #005782">while</span> @<span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">&gt;=</span> <span style="color: #93488f">128</span>
            <span style="color: #6d3642; font-weight: bold">++</span><span style="color: #000000">ptr</span>
        <span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">-</span> <span style="color: #000000">base_ptr</span>

    <span style="color: #938d7f; font-style: italic"># conversion </span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">convert</span> <span style="color: #000000">x</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">PrimitiveNumber</span>
        <span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">reinterpret_cast</span> <span style="color: #000000">Ptr</span>[ <span style="color: #000000">PI8</span> ], <span style="color: #000000">this</span>
        <span style="color: #000000">x</span>.<span style="color: #000000">construct</span> <span style="color: #93488f">0</span>
        <span style="color: #000000">shift</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #93488f">0</span>
        <span style="color: #005782">while</span> @<span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">&gt;=</span> <span style="color: #93488f">128</span>
            <span style="color: #000000">x</span> <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #000000">typeof</span>( <span style="color: #000000">x</span> )( @<span style="color: #000000">ptr</span> <span style="color: #6d3642; font-weight: bold">-</span> <span style="color: #93488f">128</span> ) <span style="color: #6d3642; font-weight: bold">&lt;&lt;</span> <span style="color: #000000">shift</span>
            <span style="color: #000000">shift</span> <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #93488f">7</span>
            <span style="color: #6d3642; font-weight: bold">++</span><span style="color: #000000">ptr</span>
        <span style="color: #000000">x</span> <span style="color: #6d3642; font-weight: bold">+=</span> <span style="color: #000000">typeof</span>( <span style="color: #000000">x</span> )( @<span style="color: #000000">ptr</span> ) <span style="color: #6d3642; font-weight: bold">&lt;&lt;</span> <span style="color: #000000">shift</span>
            
    <span style="color: #938d7f; font-style: italic"># display</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">write_to_stream</span> <span style="color: #005782">mut</span> <span style="color: #000000">os</span>
        <span style="color: #000000">os</span> <span style="color: #6d3642; font-weight: bold">&lt;&lt;</span> <span style="color: #000000">T</span> <span style="color: #000000">self</span>

<span style="color: #938d7f; font-style: italic"># usage example</span>
<span style="color: #00aaff">class</span> <span style="color: #000000">MyClass</span>
    <span style="color: #000000">a</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">PI32</span>
    <span style="color: #000000">b</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">PT</span>

<span style="color: #000000">C</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">CompactRepr</span>[ <span style="color: #000000">MyClass</span> ]

<span style="color: #000000">i</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">reinterpret_cast</span> <span style="color: #000000">Ptr</span>[ <span style="color: #000000">C</span> ], <span style="color: #000000">my_ptr</span>
<span style="color: #000000">info</span> <span style="color: #000000">sizeof</span> <span style="color: #000000">i</span> <span style="color: #938d7f; font-style: italic"># something between 2 and 15 bytes</span>
<span style="color: #000000">info</span> <span style="color: #000000">i</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">a</span>
<span style="color: #000000">info</span> <span style="color: #000000">i</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">b</span>
</pre></div>
<p></p>
</section>
<section id="Asynchronouscode">
<h1>Asynchronous code</h1>
<p>Sane allows functions to pause when they do not have the data needed to progress. It can be seen as a kind of <strong>data-driven coroutine</strong> ability. It can also be seen as a <a href="http://reactivex.io">Reactive Extension</a> with a deep support from the language. It allows to transparently work with <code>for</code>s, <code>if</code>s, ... and to generate highly optimized code (with less copies, indirections, ...).</p>

<p>Nevertheless, it is purely optional (activated only if RX function are used). Remark: the current event loop is simple and does not give the full control to the developers (for the scheduling, message passing, thread pinning, etc...). There's work to do on this topic.</p>

<!-- Besides, a runtime can't be defined by a language, it has to be a library: needs are the same if you're on the embedded world, if you're developing a game, and so on... -->

<p>A simple example:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #005782">import</span> <span style="color: #000000">fs</span>

<span style="color: #938d7f; font-style: italic"># reads are launched in parallel</span>
<span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">read</span>( <span style="color: #118811">&quot;a.txt&quot;</span> )
<span style="color: #000000">b</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">read</span>( <span style="color: #118811">&quot;b.txt&quot;</span> )
<span style="color: #000000">t</span> <span style="color: #6d3642; font-weight: bold">:=</span> <span style="color: #000000">a</span>.<span style="color: #000000">find</span> <span style="color: #000000">b</span>

<span style="color: #938d7f; font-style: italic"># this sum is computed immediatly even if the read</span>
<span style="color: #938d7f; font-style: italic"># have not finished (the content of t is not needed)</span>
<span style="color: #000000">info</span> <span style="color: #000000">sum</span> <span style="color: #000000">vec</span> 

<span style="color: #938d7f; font-style: italic"># here we say that &#39;stdout&#39; depends on the sum of the</span>
<span style="color: #938d7f; font-style: italic"># two reads, but we don&#39;t make any operation (we&#39;re </span>
<span style="color: #938d7f; font-style: italic"># just filling a graph handled at compile-time)</span>
<span style="color: #000000">info</span> <span style="color: #000000">t</span>

<span style="color: #938d7f; font-style: italic"># ...but at the end of the program, we have to make the output</span>
<span style="color: #938d7f; font-style: italic"># =&gt; execution of the graph</span>
</pre></div>
<p>It generate something like (simplified)</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #005782">struct</span> <span style="color: #000000">T0</span> {
     <span style="color: #000000">String</span> <span style="color: #000000">a0</span>;
     <span style="color: #000000">String</span> <span style="color: #000000">a1</span>;
     <span style="color: #005782">int</span>    <span style="color: #000000">a2</span>;
};
<span style="color: #005782">void</span> <span style="color: #00ff00">f1</span>( <span style="color: #000000">T0</span> <span style="color: #6d3642; font-weight: bold">*</span><span style="color: #000000">R0</span> ) {
    <span style="color: #000000">write</span>( <span style="color: #000000">find</span>( <span style="color: #000000">R0</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">a0</span>, <span style="color: #000000">R0</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">a1</span> ) );
}
<span style="color: #005782">void</span> <span style="color: #00ff00">f0</span>( <span style="color: #000000">T0</span> <span style="color: #6d3642; font-weight: bold">*</span><span style="color: #000000">R0</span> ) {
    <span style="color: #005782">if</span> ( <span style="color: #6d3642; font-weight: bold">++</span><span style="color: #000000">R0</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">a2</span> <span style="color: #6d3642; font-weight: bold">==</span> <span style="color: #93488f">3</span> )
        <span style="color: #000000">f1</span>( <span style="color: #000000">R0</span> );
}
<span style="color: #005782">int</span> <span style="color: #00ff00">main</span>() {
    <span style="color: #000000">T0</span> <span style="color: #6d3642; font-weight: bold">*</span><span style="color: #000000">R0</span> <span style="color: #6d3642; font-weight: bold">=</span> <span style="color: #000000">Allocator</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">New</span>( <span style="color: #000000">T0</span> );
    <span style="color: #000000">R0</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">a2</span> <span style="color: #6d3642; font-weight: bold">=</span> <span style="color: #93488f">0</span>;
    <span style="color: #000000">EventLoop</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">reg_read</span>( &quot;a.txt&quot;, <span style="color: #000000">f0</span>, <span style="color: #6d3642; font-weight: bold">&amp;</span><span style="color: #000000">R0</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">a0</span>, <span style="color: #000000">R0</span> );
    <span style="color: #000000">EventLoop</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">reg_read</span>( &quot;b.txt&quot;, <span style="color: #000000">f1</span>, <span style="color: #6d3642; font-weight: bold">&amp;</span><span style="color: #000000">R0</span><span style="color: #6d3642; font-weight: bold">-&gt;</span><span style="color: #000000">a1</span>, <span style="color: #000000">R0</span> );
    ... <span style="color: #938d7f; font-style: italic">// computation of the sum</span>
    <span style="color: #000000">f0</span>( <span style="color: #000000">R0</span> );
}
</pre></div>
<!-- Language support enable to generate code to make examples like that really efficient (more efficient than futures or observable which basically add layers of indirection) -->
</section>
<section id="Codegeneration">
<h1>Code generation</h1>
<p>Sane currently mainly targets C++ and Javascript (WebAsm), but other languages are welcome :)</p>

<p>In all the cases, Sane provides the tool to generate whole programs (binaries and so on), but also code for functions, classes, modules... thanks notably to the deep introspection and (again) the compile-time execution abilities.</p>

<p>For instance, one can output the contents of a class made by generative programming:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #00aaff">class</span> <span style="color: #000000">Foo</span>
    <span style="color: #00aaff">def</span> <span style="color: #000000">bar</span>
        <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">kv</span> <span style="color: #000000">sum</span> <span style="color: #93488f">0</span> .. <span style="color: #93488f">10</span>

    <span style="color: #00aaff">def</span> <span style="color: #000000">baz</span> <span style="color: #000000">a</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">SI32</span>, <span style="color: #000000">c</span>
        <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">c</span>

    <span style="color: #005782">for</span> <span style="color: #000000">name</span> <span style="color: #005782">in</span> <span style="color: #118811">&quot;ab&quot;</span>
        \<span style="color: #000000">$name</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">SI32</span>

<span style="color: #938d7f; font-style: italic"># by default, Codegen generate code for methods returning something</span>
<span style="color: #938d7f; font-style: italic"># if not specified, arg_types are found using the type constraints</span>
<span style="color: #000000">print</span> <span style="color: #000000">Codegen</span>.<span style="color: #000000">generate_code_for</span> <span style="color: #000000">Foo</span>, <span style="color: #000000">target</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #118811">&quot;C++&quot;</span>, <span style="color: #000000">arg_types</span><span style="color: #6d3642; font-weight: bold">:</span> { <span style="color: #118811">&quot;baz&quot;</span><span style="color: #6d3642; font-weight: bold">:</span> [ { <span style="color: #118811">&quot;b&quot;</span><span style="color: #6d3642; font-weight: bold">:</span> <span style="color: #000000">SI32</span> } ] }
</pre></div>
<p>It generates something like </p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #005782">class</span> <span style="color: #00ff00; font-weight: bold">Foo</span> {
<span style="color: #005782">public</span><span style="color: #6d3642; font-weight: bold">:</span>
    <span style="color: #000000">SI32</span> <span style="color: #000000">bar</span>();
    <span style="color: #000000">SI32</span> <span style="color: #00ff00">baz</span>( <span style="color: #000000">SI32</span> <span style="color: #000000">a</span>, <span style="color: #000000">SI32</span> <span style="color: #000000">b</span> );

    <span style="color: #000000">SI32</span> <span style="color: #000000">a</span>;
    <span style="color: #000000">SI32</span> <span style="color: #000000">b</span>;
}

<span style="color: #000000">SI32</span> <span style="color: #000000">Foo</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">bar</span>() {
    <span style="color: #005782">return</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #93488f">45</span>;
}
<span style="color: #000000">SI32</span> <span style="color: #000000">Foo</span><span style="color: #6d3642; font-weight: bold">::</span><span style="color: #000000">baz</span>( <span style="color: #000000">SI32</span> <span style="color: #000000">a</span>, <span style="color: #000000">SI32</span> <span style="color: #000000">b</span> ) {
    <span style="color: #005782">return</span> <span style="color: #000000">a</span> <span style="color: #6d3642; font-weight: bold">+</span> <span style="color: #000000">b</span>;
}
</pre></div>
<p></p>
</section>
<section id="Currentstatus">
<h1>Current status</h1>
<p>All the features in the documents have been tested in intermediate prototypes. Since there's stable interpreter, the compiler is currently rewritten in Sane... so it's totally a good time for comments and potentially deep modifications !</p>
</section>
</main>
      </div>
    </div>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
  </body>
</html>

            
